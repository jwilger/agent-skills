version: "2.0.0"
title: "Code Review: {{ branch_name }}"
description: >-
  Three-stage code review covering spec compliance, code quality, and
  domain integrity.

instructions: |
  You are performing a three-stage code review. Each stage must pass before
  proceeding to the next. If any stage fails, report the issues and stop.

  STAGE 1: SPEC COMPLIANCE
  Review every changed file against the requirements.
  - Does every acceptance criterion have a corresponding test?
  - Do tests match the Given/When/Then scenarios (if they exist)?
  - Are there behavioral changes without test coverage?
  - Are there tests that don't map to any requirement?
  Report: PASS or FAIL with specific findings for each criterion.

  STAGE 2: CODE QUALITY
  Review the implementation for craftsmanship.
  - Dead code: unused functions, unreachable branches, commented-out code
  - Duplication: repeated logic that should be extracted
  - Naming: unclear or misleading names
  - Complexity: functions doing too many things, deep nesting
  - Error handling: swallowed errors, generic catches, missing cases
  Report: PASS or FAIL with specific findings and file:line references.

  STAGE 3: DOMAIN INTEGRITY
  Review for domain modeling quality.
  - Primitive obsession: String/int/float where domain types should exist
  - Parse-don't-validate violations: validation deep in logic instead of
    at construction boundaries
  - Anemic models: data structures without behavior
  - Invalid states representable: struct/class that allows contradictory
    field combinations
  - Runtime checks that the type system could enforce at compile time
  Report: PASS or FAIL with specific violations and proposed type fixes.

  FINAL VERDICT: ALL STAGES PASS or list blocking issues that must be
  resolved before merge.

prompt: |
  Review the changes on branch {{ branch_name }}.

  Run `git diff {{ base_branch }}...{{ branch_name }}` to see the changes.
  Then perform the three-stage review.

parameters:
  - key: branch_name
    input_type: string
    requirement: required
    description: "Branch to review"
  - key: base_branch
    input_type: string
    requirement: optional
    default: "main"
    description: "Base branch to diff against"

extensions:
  - type: builtin
    name: developer
    display_name: Developer
    timeout: 300
    bundled: true

activities:
  - "Stage 1: Check spec compliance and test coverage"
  - "Stage 2: Review code quality and craftsmanship"
  - "Stage 3: Audit domain integrity and type safety"
