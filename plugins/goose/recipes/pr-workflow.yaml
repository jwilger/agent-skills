version: "1.1.1"
title: "PR Workflow: {{ branch_name }}"
description: >-
  Create a pull request with quality gates: test verification, code review,
  and optional mutation testing.

instructions: |
  You are preparing a pull request. Follow these steps in order, stopping
  if any gate fails.

  STEP 1: PRE-FLIGHT CHECKS
  - Run the full test suite. All tests must pass.
  - Check for compiler/linter warnings. Resolve any new warnings.
  - Check for dead code. Remove anything unused.
  - Verify all changes are committed (no uncommitted modifications).
  Report results before proceeding.

  STEP 2: MUTATION TESTING (if available)
  - If a mutation testing tool is available (cargo-mutants, mutmut,
    Stryker, pitest), run it against the changed files.
  - Target: 100% mutation kill rate on new/modified code.
  - If mutations survive, report which tests are insufficient and what
    assertions are missing.
  - If no mutation tool is available, skip with a note.

  STEP 3: THREE-STAGE CODE REVIEW
  Perform the three-stage review:
  1. Spec compliance: every requirement has a test
  2. Code quality: no dead code, duplication, or complexity issues
  3. Domain integrity: no primitive obsession, types enforce invariants
  Report PASS/FAIL for each stage.

  STEP 4: CREATE THE PR
  If all gates pass:
  - Generate a PR title (under 70 characters, describes the change)
  - Generate a PR body with:
    - Summary: what changed and why (2-3 sentences)
    - Test evidence: test results, mutation testing results
    - Review findings: summary of three-stage review
  - Create the PR using `gh pr create`

  If any gate failed, report what needs to be fixed before the PR can
  be created. Do not create a PR with known failures.

prompt: |
  Prepare and create a pull request for branch {{ branch_name }}.

  Run the quality gates and create the PR if everything passes.

parameters:
  - key: branch_name
    input_type: string
    requirement: required
    description: "Branch to create PR from"
  - key: base_branch
    input_type: string
    requirement: optional
    default: "main"
    description: "Target branch for the PR"

extensions:
  - type: builtin
    name: developer
    display_name: Developer
    timeout: 300
    bundled: true

activities:
  - "Run test suite and check for warnings"
  - "Run mutation testing on changed files"
  - "Perform three-stage code review"
  - "Create pull request with quality evidence"

retry:
  max_retries: 1
  checks:
    - type: shell
      command: "git status --porcelain | head -1 | grep -q '^' && echo 'uncommitted changes' && exit 1 || exit 0"
